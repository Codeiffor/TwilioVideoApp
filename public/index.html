<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Twilio Video</title>
    <script src="https://media.twiliocdn.com/sdk/js/video/releases/2.0.0-beta6/twilio-video.min.js"></script>
</head>
<body>
    <p>user name <input type="text" name="name" class="name"></p>
    <p>room name <input type="text" name="room" class="roomname"></p>
    <button class="connect-btn">connect</button>
    <div class="vid1"></div>
    <div class="vid2"></div>


    <script>
        document.querySelector(".connect-btn").addEventListener("click", (event) => {
            connectUser();
        })
        function connectUser(){
            var name = document.querySelector(".name").value;
            var _room = document.querySelector(".roomname").value;
            fetch(window.location.origin+"/accesstoken/"+_room+"/"+name)
                .then(function(response) {
                    if (response.status !== 200) {
                        console.log('Looks like there was a problem. Status Code: ' +response.status);
                        return;
                    }
                    response.json().then(function(data) {
                        console.log(data);
                        connectVideo(data, _room);
                    });
                }
            ).catch(function(err) {
                console.log('Fetch Error : ', err);
            });
        }
        function connectVideo(data, _room){
            Twilio.Video.connect(data.jwt, {
                audio: true,
                name: _room,
                video: { width: 640 }
            }).then(room => {
                console.log(`Connected to Room: ${_room}`);
                room.on('participantConnected', participant => {
                    console.log(`A remote Participant connected: ${participant}`);
                    participant.on('trackSubscribed', track => {
                        document.querySelector('.vid2').appendChild(track.attach());
                    });
                });
                setVideo(room);
                }, error => {
                console.error(`Unable to connect to Room: ${error.message}`);
            });
        }
        function setVideo(room){
            Twilio.Video.createLocalTracks().then(function(localTracks) {
                var localMediaContainer = document.querySelector('.vid1');
                localTracks.forEach(function(track) {
                    localMediaContainer.appendChild(track.attach());
                });
            });
            room.participants.forEach(participant => {
                participant.on('trackSubscribed', track => {
                        document.querySelector('.vid2').appendChild(track.attach());
                    });
                // participant.tracks.forEach(publication => {
                // if (publication.isSubscribed) {
                //     console.log(publication)
                //     var track = publication.track;
                //     document.querySelector('.vid2').appendChild(track.attach());
                //     }
                // });
            });
        }
    </script>
</body>
</html>